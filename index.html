<script>
  const API_BASE = "https://keysdash.espanhaserrita.workers.dev/";

  // ====== BLOQUEIO DE DEVTOOLS ======
  (function antiDevTools() {
    const redirectURL = "/";
    document.addEventListener("keydown", (e) => {
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && ["I","i","J","j","C","c"].includes(e.key))) {
        e.preventDefault();
        window.location.replace(redirectURL);
      }
    });
    document.addEventListener("contextmenu", (e) => e.preventDefault());

    let devtools = { open: false };
    const element = new Image();
    Object.defineProperty(element, 'id', {
      get: function () { devtools.open = true; throw new Error("DevTools detectado!"); }
    });
    setInterval(function () {
      devtools.open = false;
      console.log(element);
      if (devtools.open) window.location.replace(redirectURL);
    }, 1000);
  })();
  // ==================================

  function showMsg(text, type) {
    const msg = document.getElementById('msg');
    msg.style.display = 'block';
    msg.className = 'msg ' + (type === 'error' ? 'error' : 'success');
    msg.textContent = text;
  }

  document.getElementById("loginBtn").addEventListener("click", async (e) => {
    e.preventDefault();
    const clientId = document.getElementById("clientId").value.trim();
    const key = document.getElementById("keyInput").value.trim();

    if (!clientId || !key) {
      showMsg("⚠️ Preencha todos os campos.", "error");
      return;
    }

    try {
      // LOGIN - cria cookie HttpOnly
      const res = await fetch(API_BASE + "login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        mode: "cors",
        body: JSON.stringify({ clientId, key })
      });

      const loginData = await res.json().catch(() => ({}));
      if (!res.ok) {
        showMsg("❌ Key inválida ou erro no servidor.", "error");
        console.log("Debug login:", loginData);
        return;
      }

      // VERIFY - confirma cookie no Worker
      const verifyRes = await fetch(API_BASE + "verify", {
        method: "GET",
        credentials: "include",
        mode: "cors",
        headers: { "Accept": "application/json" }
      });

      const verifyData = await verifyRes.json().catch(() => ({}));
      console.log("Debug verify:", verifyData);

      if (verifyRes.ok && verifyData.ok) {
        showMsg("✅ Acesso liberado!", "success");
        setTimeout(() => window.location.href = "dashboard.html", 700);
      } else {
        showMsg("❌ Falha na validação da sessão.", "error");
      }

    } catch (err) {
      console.error("Erro:", err);
      showMsg("⚠️ Erro ao conectar ao servidor.", "error");
    }
  });

  // animação de fundo
  const numShapes = 15;
  const bg = document.querySelector('.background');
  for (let i = 0; i < numShapes; i++) {
    let div = document.createElement('div');
    div.classList.add('shape');
    const size = Math.random() * 80 + 20;
    div.style.width = size + 'px';
    div.style.height = size + 'px';
    div.style.left = Math.random() * 100 + 'vw';
    div.style.top = Math.random() * 100 + 'vh';
    div.style.animationDuration = Math.random() * 15 + 10 + 's';
    div.style.animationDelay = Math.random() * 10 + 's';
    div.style.animationName = Math.random() < 0.5 ? 'move' : 'move-reverse';
    bg.appendChild(div);
  }
</script>
