<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gerenciamento de Banca Inteligente — Dashboard</title>
  <link rel="icon" type="image/png" href="https://i.postimg.cc/yYzNXKqx/Picsart-25-10-27-10-15-31-195.png">

<script>
  const API_BASE = "https://keysdash.espanhaserrita.workers.dev/";

  async function verificarSessao() {
    const token = sessionStorage.getItem("sessionId");
    if (!token) {
      window.location.href = "/";
      return;
    }

    try {
      const res = await fetch(API_BASE + "verify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token }),
      });
      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data.ok) {
        window.location.href = "/";
      }
    } catch (err) {
      console.error("Erro ao validar sessão:", err);
      window.location.href = "/";
    }
  }

  verificarSessao();
</script>


  <style>
    :root{
      --bg:#0b0f18;
      --panel:#0f1524;
      --panel-2:#0d1320;
      --stroke:#1e2a47;
      --text:#e6e8ee;
      --muted:#a8b0c3;
      --primary:#8b5cf6;   /* roxo */
      --primary-2:#7c3aed;
      --success:#22c55e;
      --danger:#ef4444;
      --warning:#f59e0b;
      --card-radius:16px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, #141b2f 0%, transparent 60%),
                  radial-gradient(800px 600px at 90% 10%, #1a1f36 0%, transparent 60%),
                  var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      padding:24px;
    }

    /* TOP BAR */
    .topbar{
      display:flex;
      align-items:center;
      gap:16px;
      justify-content:space-between;
      margin-bottom:20px;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .logo{
      /* NOVO TAMANHO E ESTILOS PARA O LOGO PNG */
      width:70px;
      height:70px;
      background-image: url('https://i.postimg.cc/yYzNXKqx/Picsart-25-10-27-10-15-31-195.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      /* Removido background-color e border-radius para deixar a área transparente */
    }
    .title{
      font-size: clamp(18px, 2.2vw, 22px);
      font-weight:800;letter-spacing:.2px;
    }
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      background:linear-gradient(180deg, var(--primary), var(--primary-2));
      border:1px solid #5b41c6;
      padding:10px 14px;border-radius:10px;
      color:white;font-weight:700;cursor:pointer;
      box-shadow: 0 6px 18px rgba(123,58,237,.35);
      transition:.2s transform;
    }
    .btn.ghost{
      background:transparent;border:1px solid var(--stroke);color:var(--text);
      box-shadow:none;
    }
    .btn.danger{background:linear-gradient(180deg, #ef4444, #b91c1c);border-color:#b91c1c; box-shadow:0 6px 18px rgba(239,68,68,.35)}
    .btn:hover{transform:translateY(-1px)}

    /* LAYOUT */
    .grid{
      display:grid;
      grid-template-columns: 1.3fr 1fr;
      gap:20px;
    }
    @media (max-width: 1024px){
      .grid{grid-template-columns:1fr}
    }

    /* SUMMARY KPIs */
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:16px;
      margin-bottom:14px;
    }
    @media (max-width: 900px){
      .kpis{grid-template-columns:1fr 1fr}
    }
    .kpi{
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid var(--stroke);
      border-radius:var(--card-radius);
      padding:16px;
      box-shadow:var(--shadow);
      position:relative;overflow:hidden;
    }
    .kpi h4{margin:0 0 6px 0;color:#cbd5e1;font-size:13px;font-weight:700; letter-spacing:.3px}
    .kpi .val{font-size:22px;font-weight:800}
    .tag{
      position:absolute; right:12px; top:12px;
      font-size:12px; padding:6px 10px;
      border-radius:999px; border:1px solid var(--stroke); color:var(--muted);
      background:rgba(255,255,255,.02);
    }

    /* PANEL BLOCKS */
    .panel{
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid var(--stroke);
      border-radius:var(--card-radius);
      padding:18px;
      box-shadow:var(--shadow);
    }
    .panel h3{
      margin:0 0 14px 0;
      font-size:16px; letter-spacing:.3px;
      color:#dbe0ea; font-weight:800;
      display:flex; align-items:center; justify-content:space-between;
    }
    .sub{font-size:12px;color:var(--muted)}

    /* FORM + DONUT */
    .form-donut{
      display:grid; gap:18px; grid-template-columns: 1fr 220px;
      align-items:stretch;
    }
    @media (max-width: 780px){
      .form-donut{grid-template-columns:1fr}
    }
    form{
      display:grid; gap:10px;
    }
    .field{
      display:grid; gap:6px;
    }
    .field label{font-size:13px;color:#cbd5e1;font-weight:700}
    .input{
      background:#0b1120;
      border:1px solid var(--stroke);
      border-radius:12px; color:var(--text);
      padding:12px 12px; font-size:14px; font-weight:700;
      outline:none;
      transition:border .2s, box-shadow .2s, background .2s;
    }
    .input:focus{
      border-color:#6e59d9; box-shadow:0 0 0 4px rgba(139,92,246,.15);
      background:#0b1020;
    }
    .btn-block{width:100%; padding:12px; border-radius:12px; font-size:15px}
    .hint{font-size:12px;color:#7ee787}

    .donut-wrap{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      border:1px dashed var(--stroke);
      border-radius:14px;
      padding:14px;
      background: rgba(139,92,246,.05);
    }
    .progress-container{
      width:170px;height:170px; position:relative;
      display:flex; align-items:center; justify-content:center;
    }
    .donut{
      width:100%;height:100%;border-radius:50%;
      background: conic-gradient(var(--primary) 0%, #2a3354 0%);
      transition: background .6s ease;
      box-shadow: inset 0 0 30px rgba(0,0,0,.6);
      position:relative;
    }
    .donut::before{
      content:""; position:absolute; inset:16px; border-radius:50%;
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid var(--stroke);
    }
    .progress-text{
      position:absolute; font-size:28px; font-weight:900; color:#a7f3d0;
      text-shadow:0 0 18px rgba(34,197,94,.35);
    }
    .progress-label{margin-top:10px; color:var(--muted); font-size:13px}

    /* CARDS */
    #cards-container{
      display:grid; gap:16px;
      grid-template-columns: repeat( auto-fill, minmax(300px, 1fr) );
    }
    .card{
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid var(--stroke);
      border-radius:var(--card-radius);
      padding:16px;
      position:relative; min-height:240px;
      box-shadow:var(--shadow);
      transition: transform .2s, box-shadow .2s;
    }
    .card:hover{ transform:translateY(-2px); box-shadow:0 18px 40px rgba(0,0,0,.45) }
    .card h3{margin:0 0 10px 0; color:#c7d2fe; font-size:14px; letter-spacing:.4px; font-weight:800; text-transform:uppercase}
    .label{font-size:12px;color:#aab3c9; font-weight:800}
    .value{font-size:18px;font-weight:900;color:#a7f3d0;margin-top:4px}
    .info-row{display:flex;justify-content:space-between;margin:8px 0;font-size:12px;font-weight:800}
    .stop-loss{color:#fecaca}
    .target-green{color:#a7f3d0}
    .bet-info{font-size:12px;color:#86efac;text-align:center;margin:8px 0;font-weight:900}
    .card input{
      width:100%;
      background:#0b1120;border:1px solid var(--stroke);
      border-radius:10px;color:var(--text);padding:10px; font-size:14px; font-weight:800;
      outline:none;
    }
    .card input:focus{border-color:#6e59d9; box-shadow:0 0 0 4px rgba(139,92,246,.15)}
    .card-buttons{display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:12px}
    .card-buttons button{
      border-radius:10px;padding:10px;font-weight:900;border:1px solid var(--stroke); cursor:pointer;
      background:#0b1120; color:var(--text);
      transition:.2s transform;
    }
    .card-buttons button:hover{transform:translateY(-1px)}
    .card-buttons .neutral{background:#0b1224}
    .card-buttons .green{background: rgba(34,197,94,.12); border-color:#2a9d5b}
    .card-buttons .red{background: rgba(239,68,68,.12); border-color:#b91c1c}

    .overlay{position:absolute; inset:0; border-radius:var(--card-radius); pointer-events:none; opacity:.35; transition:.2s}
    .overlay.green{background: radial-gradient(circle at 30% 20%, rgba(34,197,94,.35), transparent 55%), rgba(34,197,94,.25)}
    .overlay.red{background: radial-gradient(circle at 70% 30%, rgba(239,68,68,.35), transparent 60%), rgba(239,68,68,.25)}
    .overlay.neutral{background: rgba(37,99,235,.25)}
    
    /* Custom (Lucro Maior que a Meta) é roxo */
    .overlay.custom{background: radial-gradient(circle at 50% 50%, rgba(139,92,246,.35), transparent 70%), rgba(139,92,246,.25)}

    /* FOOTER */
    .footer{margin:22px 0 0; color:var(--muted); font-size:12px; text-align:center}

    /* HIDDEN INPUT */
    #import-file{display:none}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">Gerenciamento de Banca Inteligente <span class="sub">• Dashboard</span></div>
    </div>
    <div class="actions">
      <button class="btn ghost" onclick="window.location.href='dashboard.html'">Voltar</button>
      <button class="btn" onclick="exportData()">Extrair Resultados</button>
      <button class="btn ghost" onclick="document.getElementById('import-file').click()">Importar</button>
      <input id="import-file" type="file" accept=".json" onchange="importData(event)"/>
      <button class="btn danger" onclick="clearAllData()">Limpar Tudo</button>
    </div>
  </div>

  <section class="kpis">
    <div class="kpi">
      <span class="tag">Atual</span>
      <h4>Banca atual</h4>
      <div class="val" id="kpi-total">R$ 0,00</div>
      <div class="sub" id="kpi-total-sub">—</div>
    </div>
    <div class="kpi">
      <span class="tag">Hoje</span>
      <h4>Greens</h4>
      <div class="val" id="kpi-greens">0</div>
      <div class="sub">dias marcados como green/custom</div>
    </div>
    <div class="kpi">
      <span class="tag">Hoje</span>
      <h4>Reds</h4>
      <div class="val" id="kpi-reds">0</div>
      <div class="sub">dias marcados como red</div>
    </div>
    <div class="kpi">
      <span class="tag">Progresso</span>
      <h4>Dias concluídos</h4>
      <div class="val" id="kpi-progress">0%</div>
      <div class="sub">de 30 dias</div>
    </div>
  </section>

  <div class="grid">
    <section class="panel">
      <h3>Configuração <span class="sub">defina sua banca e metas</span></h3>
      <div class="form-donut">
        <form id="input-form">
          <div class="field">
            <label>Valor da banca inicial</label>
            <input class="input" type="number" id="initial" step="0.01" required />
          </div>
          <div class="field">
            <label>Porcentagem da meta (Green) <span class="hint">(sugestão: 10%)</span></label>
            <input class="input" type="number" id="green" step="0.01" required />
          </div>
          <div class="field">
            <label>Porcentagem do stop (Red)</label>
            <input class="input" type="number" id="red" step="0.01" required />
          </div>
          <div class="field">
            <label>Valor de Bet (% ao dia) <span class="hint">(sugestão: 5%)</span></label>
            <input class="input" type="number" id="bet" step="0.01" required />
          </div>
          <button type="button" class="btn btn-block" onclick="calculate()">Calcular 30 Dias</button>
        </form>

        <div class="donut-wrap">
          <div class="progress-container">
            <div class="donut" id="donut"></div>
            <div class="progress-text" id="progress-text">0%</div>
          </div>
          <div class="progress-label">Dias completos</div>
        </div>
      </div>
    </section>

    <section class="panel">
      <h3>Controle diário <span class="sub">marque o resultado do dia</span></h3>
      <div id="cards-container"></div>
    </section>
  </div>

  <div class="footer">
    Todos os dados são salvos automaticamente no seu navegador.
  </div>

  <script>
    let initial = 0, greenP = 0, redP = 0, betP = 0;
    const inputsKey = 'banca_inputs';
    const daysKey = 'banca_days';

    window.onload = () => { loadInputs(); updateDays(); updateProgress(); updateSummary(); };

    function loadInputs() {
      const saved = localStorage.getItem(inputsKey);
      if (saved) {
        const d = JSON.parse(saved);
        document.getElementById('initial').value = d.initial || '';
        document.getElementById('green').value = d.greenP || '';
        document.getElementById('red').value = d.redP || '';
        document.getElementById('bet').value = d.betP || '';
        initial = d.initial || 0;
        greenP = d.greenP || 0;
        redP = d.redP || 0;
        betP = d.betP || 0;
      }
    }

    function calculate() {
      const i = parseFloat(document.getElementById('initial').value) || 0;
      const g = parseFloat(document.getElementById('green').value) || 0;
      const r = parseFloat(document.getElementById('red').value) || 0;
      const b = parseFloat(document.getElementById('bet').value) || 0;

      if (i <= 0 || g <= 0 || r <= 0 || b <= 0) {
        alert('Preencha todos os campos com valores positivos (maiores que 0).');
        return;
      }

      initial = i; greenP = g; redP = r; betP = b;
      localStorage.setItem(inputsKey, JSON.stringify({initial, greenP, redP, betP}));

      const days = [];
      let current = initial;
      for (let d = 0; d < 30; d++) {
        days.push({
          starting: current,
          ending: current * (1 + greenP / 100),
          status: null
        });
        current = days[d].ending;
      }

      localStorage.setItem(daysKey, JSON.stringify(days));
      updateDays();
      updateProgress();
      updateSummary();
    }

    function updateDays() {
      let days = JSON.parse(localStorage.getItem(daysKey)) || [];
      const container = document.getElementById('cards-container');
      container.innerHTML = '';

      while (days.length < 30) {
        const last = days[days.length - 1] || {ending: initial};
        days.push({
          starting: last.ending,
          ending: last.ending * (1 + greenP / 100),
          status: null
        });
      }

      days.forEach((day, i) => {
        const starting = day.starting;
        const recBet = starting * (betP / 100);
        const stopLoss = starting * (redP / 100);
        const stopValue = starting - stopLoss;
        const greenTarget = starting * (1 + greenP / 100);
        
        const displayEnding = day.status ? day.ending : greenTarget;

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>Dia ${i + 1}</h3>
          <div><span class="label">Banca inicial</span><div class="value">R$ ${starting.toFixed(2)}</div></div>
          <div class="bet-info">Bet sugerido: R$ ${recBet.toFixed(2)} (${betP}%)</div>
          <div class="info-row stop-loss"><span>Stop</span><span>-R$ ${stopLoss.toFixed(2)} • até R$ ${stopValue.toFixed(2)}</span></div>
          <div class="info-row target-green"><span>Meta</span><span>+R$ ${(greenTarget - starting).toFixed(2)} • R$ ${greenTarget.toFixed(2)}</span></div>
          <div>
            <span class="label">Banca final</span>
            <input type="number" id="ending-input-${i}" step="0.01" value="${displayEnding.toFixed(2)}" onchange="updateEnding(${i}, this.value)">
          </div>
          <div class="card-buttons">
            <button class="green" onclick="setResult(${i}, 'green')">Green</button>
            <button class="neutral" onclick="setResult(${i}, 'neutral')">0 a 0</button>
            <button class="red" onclick="setResult(${i}, 'red')">Red</button>
          </div>
        `;

        if (day.status) {
          const overlay = document.createElement('div');
          overlay.className = `overlay ${day.status}`;
          card.appendChild(overlay);
        }

        container.appendChild(card);
      });

      localStorage.setItem(daysKey, JSON.stringify(days));
      updateProgress();
      updateSummary();
    }

    function determineStatus(starting, ending, greenP, redP) {
        const greenTarget = starting * (1 + greenP / 100);
        const redStop = starting * (1 - redP / 100);
        
        if (ending > greenTarget) return 'custom'; // Lucro acima da meta (Roxo)
        if (Math.abs(ending - greenTarget) < 0.01) return 'green'; // Exatamente na meta (Verde)
        if (ending > starting && ending < greenTarget) return 'custom'; // Lucro abaixo da meta mas acima do 0 (Roxo - Tratamos como Green/Custom)
        if (Math.abs(ending - starting) < 0.01) return 'neutral'; // 0 a 0 (Azul)
        if (ending <= redStop) return 'red'; // Stop Loss ou abaixo (Vermelho)
        
        return null; // Não marcado
    }
    
    function updateEnding(i, val) {
      const v = parseFloat(val);
      if (isNaN(v) || v <= 0) return updateDays();

      const days = JSON.parse(localStorage.getItem(daysKey));
      const day = days[i];

      day.ending = v;
      day.status = determineStatus(day.starting, v, greenP, redP);

      for (let j = i + 1; j < 30; j++) {
        days[j].starting = days[j-1].ending;
        days[j].ending = days[j].starting * (1 + greenP / 100);
        days[j].status = null;
      }

      localStorage.setItem(daysKey, JSON.stringify(days));
      updateDays();
    }

    function setResult(i, status) {
      const days = JSON.parse(localStorage.getItem(daysKey));
      const day = days[i];
      
      let endingValueToSet;

      if (status === 'green') {
          endingValueToSet = day.starting * (1 + greenP / 100);
      } else if (status === 'red') {
          endingValueToSet = day.starting * (1 - redP / 100);
      } else if (status === 'neutral') {
          endingValueToSet = day.starting;
      }
      
      const inputElement = document.getElementById(`ending-input-${i}`);
      if (inputElement) {
        inputElement.value = endingValueToSet.toFixed(2);
        updateEnding(i, endingValueToSet);
      }
    }

    function updateProgress() {
      const days = JSON.parse(localStorage.getItem(daysKey)) || [];
      const completed = days.filter(d => d.status !== null).length;
      const percentage = Math.round((completed / 30) * 100);

      document.getElementById('progress-text').textContent = `${percentage}%`;

      const donut = document.getElementById('donut');
      donut.style.background = `conic-gradient(var(--primary) 0% ${percentage}%, #2a3354 ${percentage}% 100%)`;

      const p = document.getElementById('kpi-progress');
      if (p) p.textContent = `${percentage}%`;
    }

    function updateSummary(){
      const days = JSON.parse(localStorage.getItem(daysKey) || '[]');
      if (!days.length){
        document.getElementById('kpi-total').textContent = 'R$ 0,00';
        document.getElementById('kpi-greens').textContent = '0';
        document.getElementById('kpi-reds').textContent = '0';
        document.getElementById('kpi-total-sub').textContent = '—';
        return;
      }
      const completed = days.filter(d => d.status !== null);
      
      const greens = completed.filter(d => d.status === 'green' || d.status === 'custom').length;
      const reds = completed.filter(d => d.status === 'red').length;
      
      const lastEnding = completed.length > 0 ? days[completed.length - 1].ending : initial;
      const init = JSON.parse(localStorage.getItem(inputsKey) || '{}').initial || 0;
      
      const diff = lastEnding - (init || lastEnding);
      const sign = diff >= 0 ? '+' : '';

      document.getElementById('kpi-greens').textContent = greens;
      document.getElementById('kpi-reds').textContent = reds;
      document.getElementById('kpi-total').textContent = 'R$ ' + lastEnding.toFixed(2);
      
      if (init > 0) {
        document.getElementById('kpi-total-sub').textContent = `${sign} R$ ${Math.abs(diff).toFixed(2)}`;
      } else {
        document.getElementById('kpi-total-sub').textContent = '—';
      }
    }

    function exportData() {
      const data = { inputs: JSON.parse(localStorage.getItem(inputsKey) || '{}'), days: JSON.parse(localStorage.getItem(daysKey) || '[]') };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `banca_${new Date().toISOString().slice(0,10)}.json`; a.click();
      URL.revokeObjectURL(url);
    }

    function importData(e) {
      const file = e.target.files[0];
      if (!file || !confirm('Substituir todos os dados?')) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const d = JSON.parse(ev.target.result);
          if (d.inputs) localStorage.setItem(inputsKey, JSON.stringify(d.inputs));
          if (d.days) localStorage.setItem(daysKey, JSON.stringify(d.days));
          loadInputs(); updateDays(); updateProgress(); updateSummary(); alert('Importado!');
        } catch { alert('Erro no arquivo.'); }
      };
      reader.readAsText(file);
    }

    function clearAllData() {
      if (confirm('APAGAR TUDO?')) {
        localStorage.removeItem(inputsKey);
        localStorage.removeItem(daysKey);
        document.getElementById('input-form').reset();
        document.getElementById('cards-container').innerHTML = '';
        initial = greenP = redP = betP = 0;
        updateProgress();
        updateSummary();
        alert('Tudo limpo!');
      }
    }
  (function antiDevTools() {
    const redirectURL = "/"; // volta pro login

    document.addEventListener("keydown", (e) => {
      if (
        e.key === "F12" ||
        (e.ctrlKey && e.shiftKey && ["I","i","J","j","C","c"].includes(e.key))
      ) {
        e.preventDefault();
        window.location.replace(redirectURL);
      }
    });

    document.addEventListener("contextmenu", (e) => e.preventDefault());

    const element = new Image();
    Object.defineProperty(element, "id", {
      get: function () {
        throw new Error("DevTools detectado!");
      },
    });

    setInterval(() => {
      console.log(element);
    }, 1000);
  })();
</script>

</body>
</html>
